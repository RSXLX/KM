# 架构合规性检查未完成项报告（kmarket-backend）

- 日期：2025-11-06
- 参考规范：前端 Next.js + WebSocket；后端 Rust（API Gateway：Axum、WebSocket Server、Tokio 定时任务）；服务层（Odds/Market/Betting/User/Settlement）；数据访问层（PostgreSQL/SQLx、Redis/redis-rs、BSC RPC/ethers-rs）；外部依赖（PostgreSQL、Redis、BSC 网络、第三方赔率 API）

---

## 总览结论

项目整体结构接近目标架构（Rust + SQLx + Redis + WebSocket），但与图片设计规范仍存在差异与缺失：
- Web 框架采用 Actix-Web 而非 Axum。
- 服务层模块未完整（缺 BettingService 与 UserService）。
- REST 路由前缀与版本标识不统一（`/markets` 与 `/api/v1/*` 并存）。
- 缺少独立的 Tokio 定时任务与外部数据源拉取（第三方赔率、链上事件）。
- 仅使用 `ethers` 进行签名验证，未落地 BSC RPC 的业务流程与事件监听。
- 数据库设计可进一步规范化（用户外键、校验约束等）。
- 中间件配置可增强（CORS 来源通过配置、WS 统计指标完善）。

以下为不符合项的详细说明、定位、预期实现以及修复优先级评估。

---

## 不符合项清单（摘要表）

| 分类 | 具体问题 | 位置 | 预期实现 | 优先级 |
|---|---|---|---|---|
| 框架选型 | API Gateway 使用 Actix-Web 而非规范中的 Axum | `Cargo.toml` 依赖 | 统一到 Axum 或更新规范文档为 Actix-Web | 中 |
| 服务层模块 | 缺少 BettingService 与 UserService | `src/services/mod.rs` 仅导出 `market/odds/settlement` | 增加 `betting.rs` 与 `user.rs` 服务抽象与实现 | 中 |
| REST 版本化 | 路由前缀不统一：`/markets` VS `/api/v1/bets` | `routes/markets.rs:#42/#130`、`routes/bets.rs:#46` | 统一为 `/api/v1/*`（或配置化版本前缀） | 中 |
| 定时任务 | 无独立 Tokio 任务（仅 WS 心跳） | `ws.rs:#189-201`（心跳） | 新增 `tokio::spawn` + `interval` 定时拉取与广播 | 高 |
| BSC RPC | 未集成链上 Provider/事件订阅 | `routes/auth.rs` 使用 `ethers::types::Signature` | 集成 `Provider<Http>`、订阅合约事件写入 DB | 中 |
| 赔率来源 | 未接入第三方赔率 API（仅 DB 计算/覆盖） | `services/odds.rs` | 增加外部 API 拉取与回退策略 | 中 |
| 数据库规范 | 订单表使用 `user_address`，缺少正向外键与校验 | `migrations/0005_orders.sql` | 改为 `user_id` 外键；增加金额/赔率范围校验 | 中 |
| 中间件配置 | CORS 来源硬编码；WS 指标不完整 | `main.rs` CORS、`ws.rs` 统计 | CORS 来源配置化；补充广播延迟指标采集 | 低 |
| 监控与健康 | WS 健康接口有统计但无延迟指标 | `routes/ws_health.rs` | 返回 p95 延迟，连接数、订阅数 | 低 |

---

## 详细问题与定位

### 1. 框架选型与规范不一致（Axum → Actix-Web）
- 位置：`c:/Users/94447/Desktop/Learn/Ibet/kmarket-backend/Cargo.toml`
- 证据（依赖片段）：
```toml
actix-web = "4"
actix-web-actors = "4"
actix = "0.13"
```
- 预期：若严格遵循图片设计，应使用 Axum 作为 API Gateway；如继续使用 Actix-Web，请在架构规范及图片中同步更新，避免前后不一致。
- 修复建议：
  - 方案 A（迁移）：分阶段将路由与中间件迁移至 Axum（路由器、Layer 中间件、提取器），保留 WebSocket 使用 `axum` + `tokio-tungstenite` 或继续 Actix WS（需分离）。
  - 方案 B（更新规范）：将图片和规范中的 API Gateway 更新为 Actix-Web，并注明选择理由与兼容性。
- 优先级：中。

### 2. 服务层模块不完整（缺 Betting/User Service）
- 位置：`src/services/mod.rs`
```rust
pub mod market;
pub mod odds;
pub mod settlement; // 缺少 betting.rs 与 user.rs
```
- 影响：业务逻辑分层不完整，投注与用户相关逻辑散落在 `routes` 与 `db::repo`，难以复用与测试。
- 预期：新增 `betting.rs` 和 `user.rs`，抽象接口并提供 `Pg*Service` 实现。
- 伪代码示例：
```rust
// src/services/betting.rs
#[async_trait]
pub trait BettingService {
    async fn place_order(&self, req: PlaceOrder) -> Result<OrderRow>;
    async fn list_orders(&self, q: ListQuery) -> Result<Vec<OrderRow>>;
    async fn claim(&self, order_id: i64) -> Result<OrderClaim>;
}

// src/services/user.rs
#[async_trait]
pub trait UserService {
    async fn get_by_wallet(&self, wallet: &str) -> Result<Option<User>>;
    async fn ensure_login(&self, wallet: &str) -> Result<i32>; // 返回 user_id
}
```
- 优先级：中。

### 3. REST 路由前缀与版本化不统一
- 位置与证据：
  - `routes/markets.rs:42`
    ```rust
    #[get("/markets")]
    ```
  - `routes/markets.rs:130`
    ```rust
    #[get("/markets/{id}")]
    ```
  - `routes/bets.rs:46`
    ```rust
    #[post("/api/v1/bets")]
    ```
- 影响：前端与网关难以统一管理版本、缓存策略与权限。
- 预期：统一采用 `/api/v1/*` 前缀（或通过 `BASE_PATH` 配置动态控制）。
- 修复建议：
  - 将 `markets`、`odds`、`readyz/healthz` 等路由迁移至 `/api/v1` 下；
  - 在 `routes::configure` 中统一注册作用域 `web::scope("/api/v1")`；
  - 为 WebSocket 保留独立 `/ws/*` 前缀。
- 优先级：中。

### 4. 缺少独立的 Tokio 定时任务（Cron Jobs）
- 位置与证据：仅在 `ws.rs:189-201` 中看到心跳机制：
```rust
ctx.run_interval(std::time::Duration::from_secs(15), |act, ctx| { /* ping/pong 心跳 */ });
```
- 影响：无法定期拉取第三方赔率、聚合市场快照、重建缓存、链上事件扫描等。
- 预期：新增任务模块 `src/bin/jobs.rs` 或 `src/tasks/cron.rs`：
```rust
#[tokio::main]
async fn main() {
    let interval = tokio::time::interval(Duration::from_secs(10));
    loop {
        interval.tick().await;
        // 1) 拉取第三方赔率并写入 Redis/DB
        // 2) 生成 markets:active 快照
        // 3) 轮询链上事件并写入 chain_events
        // 4) 通过 WsHub 广播增量更新
    }
}
```
- 优先级：高。

### 5. BSC RPC（ethers-rs）集成不足
- 位置与证据：`routes/auth.rs` 使用 `ethers::types::Signature` 做 EIP-191 验签，但未使用 `Provider` 或事件订阅。
- 预期：
  - 使用 `Provider<Http>::try_from(env.BSC_RPC_URL)?` 建立连接；
  - 通过 `Filter` 订阅合约事件（下注、结算、领取），写入 `chain_events`；
  - 失败重试与断线重连机制；
- 伪代码：
```rust
let provider = Provider::<Http>::try_from(cfg.bsc_rpc_url.unwrap())?;
let filter = Filter::new().address(cfg.contract_addr_prediction.unwrap());
let mut stream = provider.subscribe_logs(&filter).await?;
while let Some(log) = stream.next().await { /* 解析并写入 chain_events */ }
```
- 优先级：中。

### 6. 第三方赔率 API 未接入
- 位置与证据：`services/odds.rs` 中仅有基于 DB 的初始赔率计算：
```rust
pub async fn compute_moneyline_from_db(...) -> Result<Option<MoneylineOdds>> { /* ... */ }
```
- 预期：新增外部 API 拉取（HTTP 客户端）、缓存与回退策略：
  - 成功：写入 Redis `odds:{market}`（TTL 60s），并广播 WS 增量；
  - 失败：回退至 DB 或最近缓存；
- 优先级：中。

### 7. 数据库结构规范化建议
- 位置：`migrations/0005_orders.sql`
```sql
user_address VARCHAR(42) NOT NULL REFERENCES users(wallet_address)
```
- 问题：以地址作为外键，容易产生大小写/校验问题，且不便做级联更新；缺少金额/赔率范围等校验约束。
- 预期修复：
```sql
-- 新增 user_id 外键（保留 user_address 作为冗余或去除）
ALTER TABLE orders ADD COLUMN user_id INTEGER;
ALTER TABLE orders ADD CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE RESTRICT;
-- 校验约束
ALTER TABLE orders ADD CONSTRAINT chk_amount_positive CHECK (amount > 0);
ALTER TABLE orders ADD CONSTRAINT chk_odds_range CHECK (odds >= 100 AND odds <= 1000);
```
- 迁移策略：
  - 数据迁移脚本：根据地址匹配填充 `user_id`；
  - 更新仓储与服务层读写逻辑优先使用 `user_id`。
- 优先级：中。

### 8. 中间件配置改进（CORS、WS 指标）
- 位置：`src/main.rs` CORS 配置（硬编码域名），`ws.rs` `WsStats` 中 `broadcast_latency_ms_p95: None`。
- 预期：
  - CORS 允许来源通过环境变量控制（如 `CORS_ALLOW_ORIGINS`）。
  - 为 WS 广播路径增加简单延迟采样（记录 N 次广播耗时，计算 p95）。
- 伪代码：
```rust
// 采样延迟
let start = Instant::now();
for r in subs { let _ = r.do_send(update.clone()); }
self.record_latency(start.elapsed());
```
- 优先级：低。

### 9. 监控与健康接口完善
- 位置：`routes/ws_health.rs`。
- 预期：增加延迟指标返回、错误计数、最近广播时间戳等，便于观测。
- 优先级：低。

---

## 建议的正确实现方式（示例性流程图）

```mermaid
flowchart TD
  A[外部赔率API/BSC RPC] -->|定时拉取/订阅| B[Tokio 定时任务/事件监听]
  B --> C[服务层 Odds/Betting/User/Settlement]
  C --> D[(PostgreSQL/SQLx)]
  C --> E[(Redis Cache)]
  C --> F[WsHub 广播]
  D --> G[REST API (Axum/Actix)]
  E --> G
  F --> H[前端 Next.js/WebSocket]
```

---

## 结论与行动项
- 短期（高优先级）：补齐定时任务与外部数据源拉取；统一路由前缀；完善服务层抽象。
- 中期（中优先级）：集成 BSC RPC 事件监听；重构数据库外键与校验；引入版本化 API 作用域。
- 长期（低优先级）：完善 CORS 配置化、WS 指标与监控；根据团队偏好决定是否迁移到 Axum 并同步更新架构文档。

---

> 注：本文档根据当前代码库检索结果生成，若后续新增模块或文件与本报告不一致，请更新本报告并附上差异说明。